<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>S2VT</title><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px !important; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }
  .typora-export #write::after { height: 0px; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none 0s ease 0s; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="mermaid"] svg, [lang="flow"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }


:root { --side-bar-bg-color: #fafafa; --control-text-color: #777; }
html { font-size: 16px; }
body { font-family: "Open Sans", "Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif; color: rgb(51, 51, 51); line-height: 1.6; }
#write { max-width: 860px; margin: 0px auto; padding: 30px 30px 100px; }
#write > ul:first-child, #write > ol:first-child { margin-top: 30px; }
a { color: rgb(65, 131, 196); }
h1, h2, h3, h4, h5, h6 { position: relative; margin-top: 1rem; margin-bottom: 1rem; font-weight: bold; line-height: 1.4; cursor: text; }
h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor { text-decoration: none; }
h1 tt, h1 code { font-size: inherit; }
h2 tt, h2 code { font-size: inherit; }
h3 tt, h3 code { font-size: inherit; }
h4 tt, h4 code { font-size: inherit; }
h5 tt, h5 code { font-size: inherit; }
h6 tt, h6 code { font-size: inherit; }
h1 { padding-bottom: 0.3em; font-size: 2.25em; line-height: 1.2; border-bottom: 1px solid rgb(238, 238, 238); }
h2 { padding-bottom: 0.3em; font-size: 1.75em; line-height: 1.225; border-bottom: 1px solid rgb(238, 238, 238); }
h3 { font-size: 1.5em; line-height: 1.43; }
h4 { font-size: 1.25em; }
h5 { font-size: 1em; }
h6 { font-size: 1em; color: rgb(119, 119, 119); }
p, blockquote, ul, ol, dl, table { margin: 0.8em 0px; }
li > ol, li > ul { margin: 0px; }
hr { height: 2px; padding: 0px; margin: 16px 0px; background-color: rgb(231, 231, 231); border: 0px none; overflow: hidden; box-sizing: content-box; }
li p.first { display: inline-block; }
ul, ol { padding-left: 30px; }
ul:first-child, ol:first-child { margin-top: 0px; }
ul:last-child, ol:last-child { margin-bottom: 0px; }
blockquote { border-left: 4px solid rgb(223, 226, 229); padding: 0px 15px; color: rgb(119, 119, 119); }
blockquote blockquote { padding-right: 0px; }
table { padding: 0px; word-break: initial; }
table tr { border-top: 1px solid rgb(223, 226, 229); margin: 0px; padding: 0px; }
table tr:nth-child(2n), thead { background-color: rgb(248, 248, 248); }
table tr th { font-weight: bold; border-width: 1px 1px 0px; border-top-style: solid; border-right-style: solid; border-left-style: solid; border-top-color: rgb(223, 226, 229); border-right-color: rgb(223, 226, 229); border-left-color: rgb(223, 226, 229); border-image: initial; border-bottom-style: initial; border-bottom-color: initial; text-align: left; margin: 0px; padding: 6px 13px; }
table tr td { border: 1px solid rgb(223, 226, 229); text-align: left; margin: 0px; padding: 6px 13px; }
table tr th:first-child, table tr td:first-child { margin-top: 0px; }
table tr th:last-child, table tr td:last-child { margin-bottom: 0px; }
.CodeMirror-lines { padding-left: 4px; }
.code-tooltip { box-shadow: rgba(0, 28, 36, 0.3) 0px 1px 1px 0px; border-top: 1px solid rgb(238, 242, 242); }
.md-fences, code, tt { border: 1px solid rgb(231, 234, 237); background-color: rgb(248, 248, 248); border-radius: 3px; padding: 2px 4px 0px; font-size: 0.9em; }
code { background-color: rgb(243, 244, 244); padding: 0px 2px; }
.md-fences { margin-bottom: 15px; margin-top: 15px; padding-top: 8px; padding-bottom: 6px; }
.md-task-list-item > input { margin-left: -1.3em; }
@media print {
  html { font-size: 13px; }
  table, pre { break-inside: avoid; }
  pre { overflow-wrap: break-word; }
}
.md-fences { background-color: rgb(248, 248, 248); }
#write pre.md-meta-block { padding: 1rem; font-size: 85%; line-height: 1.45; background-color: rgb(247, 247, 247); border: 0px; border-radius: 3px; color: rgb(119, 119, 119); margin-top: 0px !important; }
.mathjax-block > .code-tooltip { bottom: 0.375rem; }
.md-mathjax-midline { background: rgb(250, 250, 250); }
#write > h3.md-focus::before { left: -1.5625rem; top: 0.375rem; }
#write > h4.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h5.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h6.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
.md-image > .md-meta { border-radius: 3px; padding: 2px 0px 0px 4px; font-size: 0.9em; color: inherit; }
.md-tag { color: rgb(167, 167, 167); opacity: 1; }
.md-toc { margin-top: 20px; padding-bottom: 20px; }
.sidebar-tabs { border-bottom: none; }
#typora-quick-open { border: 1px solid rgb(221, 221, 221); background-color: rgb(248, 248, 248); }
#typora-quick-open-item { background-color: rgb(250, 250, 250); border-color: rgb(254, 254, 254) rgb(229, 229, 229) rgb(229, 229, 229) rgb(238, 238, 238); border-style: solid; border-width: 1px; }
.on-focus-mode blockquote { border-left-color: rgba(85, 85, 85, 0.12); }
header, .context-menu, .megamenu-content, footer { font-family: "Segoe UI", Arial, sans-serif; }
.file-node-content:hover .file-node-icon, .file-node-content:hover .file-node-open-state { visibility: visible; }
.mac-seamless-mode #typora-sidebar { background-color: var(--side-bar-bg-color); }
.md-lang { color: rgb(180, 101, 77); }
.html-for-mac .context-menu { --item-hover-bg-color: #E6F0FE; }
#md-notification .btn { border: 0px; }
.dropdown-menu .divider { border-color: rgb(229, 229, 229); }

 .typora-export li, .typora-export p, .typora-export,  .footnote-line {white-space: normal;} 
</style>
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node first-line-indent'><div class='md-toc' mdtype='toc'><p class="md-toc-content"><span class="md-toc-item md-toc-h1" data-ref="n9"><a class="md-toc-inner" style="cursor: pointer;" href="#video-captioning---introduction">Video Captioning - Introduction</a></span><span class="md-toc-item md-toc-h1" data-ref="n40"><a class="md-toc-inner" style="cursor: pointer;" href="#s2vt-model">S2VT Model</a></span><span class="md-toc-item md-toc-h2" data-ref="n44"><a class="md-toc-inner" style="cursor: pointer;" href="#related-work">Related Work</a></span><span class="md-toc-item md-toc-h2" data-ref="n60"><a class="md-toc-inner" style="cursor: pointer;" href="#approach">Approach</a></span><span class="md-toc-item md-toc-h3" data-ref="n64"><a class="md-toc-inner" style="cursor: pointer;" href="#feature-extraction">Feature Extraction</a></span><span class="md-toc-item md-toc-h3" data-ref="n72"><a class="md-toc-inner" style="cursor: pointer;" href="#lstm-as-encoder">LSTM as Encoder</a></span><span class="md-toc-item md-toc-h3" data-ref="n78"><a class="md-toc-inner" style="cursor: pointer;" href="#lstm-as-decoder">LSTM as Decoder</a></span><span class="md-toc-item md-toc-h3" data-ref="n84"><a class="md-toc-inner" style="cursor: pointer;" href="#some-details">Some Details</a></span><span class="md-toc-item md-toc-h3" data-ref="n90"><a class="md-toc-inner" style="cursor: pointer;" href="#loss">Loss</a></span><span class="md-toc-item md-toc-h3" data-ref="n99"><a class="md-toc-inner" style="cursor: pointer;" href="#implementation">Implementation</a></span></p></div><p>&nbsp;</p><p>&nbsp;</p><p><span>最近在做Video Captioning，看了一些论文，做了一些实验。发现东西越堆越多，脑子里有点凌乱，就想着专门开一个栏，记录一下。一方面算是论文笔记，用来备忘。一方面也想记录一些自己的想法。</span></p><p><span>这篇文章是这个系列的第一篇文章，会先简单介绍一下Video Captioning是什么，再简单讨论一下Video Captioning的一个基础模型：S2VT。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h1><a name="video-captioning---introduction" class="md-header-anchor"></a><span>Video Captioning - Introduction</span></h1><p><span>所谓Video Captioning就是针对一段视频生成自然语言文本来描述视频的内容。</span></p><p><span>为视觉内容产生自然语言描述文本近年来得到不少的关注，特别是为图片生成描述，即Image Captioning。相比而言，Video Captioning受到的关注要稍微少一些，尽管它在人机交互，视频检索，自动为盲人做视频描述等应用上非常重要。</span></p><p><span>Video Captioning目前依然是一项颇有挑战的任务。对于一个视频输入，它本质上是一个变长度的帧序列。Video Captioning要求读入这样一个变长的帧序列，生成一个不定长的单词序列。</span></p><p><span>Video Captioning主要有以下几个难点：</span></p><ul><li><span>Open domain 中的视频中有大量的对象，场景，行为，属性等等，识别和捕捉这些对象存在挑战性。</span></li><li><span>Video Captioning 要求捕捉视频中的突出内容，并且准确的用自然语言描述视频中的事件。</span></li><li><span>视频的长度越长，越难生成描述。</span></li><li><span>对于一个视频生成的简单句经常很boring，难以生成内容丰富，面面俱到，详细的段落式描述。</span></li><li><span>视频中通常有多个对象和多个行为，要全面的描述并不容易。</span></li><li><span>......</span></li></ul><p><span>常用数据集：</span></p><ul><li><span>MSR-VTT</span></li><li><span>MSVD</span></li><li><span>MPII-MD</span></li><li><span>MVAD</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h1><a name="s2vt-model" class="md-header-anchor"></a><span>S2VT Model</span></h1><p><span>原论文：</span><a href='https://arxiv.org/abs/1505.00487'><span>[15 ICCV]《Sequence to Sequence – Video to Text》</span></a></p><p>&nbsp;</p><p>&nbsp;</p><h2><a name="related-work" class="md-header-anchor"></a><span>Related Work</span></h2><p><span>&quot;To our knowledge, this is the first approach to video description that uses a general sequence to sequence model.&quot;</span></p><p><span>S2VT应该算是第一个序列到序列的Video Captioning模型，它直接将Frames Sequence编码成一个定长向量，再将这个定长向量解码产生一个Words Sequence。</span></p><p><span>在这之前，Video Captioning的方法大概有这样三种：</span></p><ul><li><span>通过对训练数据中的captions和videos进行聚类，把captioning问题变成一个retrieval task。</span></li><li><span>通过预定义的句子模板生成captions，模型只需要为这些模板从visual content中解析出semantic content（subject, verb ,obect ..）。</span></li><li><span>将每一帧丢入CNN处理，提取特征，然后做一个mean-pooling产生single feature vector来表示整个视频，然后再用LSTM作为decoder将这个vector解码成一段单词序列。</span></li></ul><p><span>这三种方法中，第一种无法产生novel sentence，相当于只是在做一个数据库检索；第二种产生的句式非常僵硬，不够丰富；第三种通过LSTM做generative task，可以进行较好的生成，但是没有考虑帧之间的序列顺序。</span></p><p><span>S2VT可以看作第三种方法的一个改进，它没有把CNN处理过的特征图直接拿来做mean-pooling，取而代之，它做的是把这些特征图按顺序输入一个LSTM中。在</span><a href='http://122.152.198.128/?p=1594'><span>Recurrent Neural Network</span></a><span>这篇文章中，我们已经介绍过RNN和LSTM，我们知道RNN很适合对序列信息进行建模。S2VT就是利用了这一性质，将每一帧的特征顺序输入LSTM中，最后产生一个定长的向量，这个向量既包含了视频的特征信息，又包含了帧的时序信息，优于mean-pooling的方法。</span></p><p><span>S2VT的架构基本上就是照着Neural Translation的架构搬过来的。机器翻译广泛采用的一种架构就是将一种语言的句子丢入LSTM，产生一个特征向量，再把这个特征向量丢入另一个LSTM解码出另一种语言的句子。在Video Captioning中，唯一不同的仅仅是它是把图片序列转为词序列，而不是词序列转词序列。</span></p><p>&nbsp;</p><p>&nbsp;</p><h2><a name="approach" class="md-header-anchor"></a><span>Approach</span></h2><p><img src='https://raw.githubusercontent.com/Unispac/blogImageBed/master/计算机视觉/Video%20Captioning/S2VT/img/0.png' alt='S2VT' referrerPolicy='no-referrer' /></p><p><span>S2VT的基本架构如上所示。结构很简单，第一层LSTM用来对帧序列编码，第二层用来对编码向量解码，从而生成sentence。</span><strong><span>是非常常见的Encoder-Decoder结构。</span></strong></p><p>&nbsp;</p><h3><a name="feature-extraction" class="md-header-anchor"></a><span>Feature Extraction</span></h3><p><span>需要注意的是，上面这个示意图看上去是直接把帧图片丢入LSTM中，这其实只是为了简化理解。在实际的执行中，对LSTM输入的序列不是裸的图片，而是处理过的特征图。在丢入LSTM前，一段视频会先被按一定帧率截取成帧序列，这些帧图片会被丢入一个预训练好的模型，最后产生对应的特征图序列。</span></p><p><span>S2VT中，使用的是ImageNet Challenge中的VGGNet-16。</span></p><p><span>众所周知VGG-16是一个用来做Image Classification的模型（如果不知道，可以看看这篇文章</span><a href='http://122.152.198.128/?p=1532'><span>浅谈深度卷积神经网络</span></a><span>），这和我们这里的Video Captioning有啥关系呢？</span></p><p><span>这是因为CNN架构中的卷积层被普遍认为拥有提取图片特征的能力，在对CNN的每一层输出可视化后，也可以看到很明显的图片从特殊到泛化的一个抽象过程。因此我们期望的是VGGNet的中间卷积层能给出图片更为一般化的特征信息，这些特征序列能更容易的被LSTM编码。（相邻的两个帧图片，可能在语义上区别不大，但是裸的RGB编码向量却可能发生很大的变化。LSTM是对序列做建模，如果直接对LSTM输入帧图片序列，语义上有连贯性的序列可能在向量空间中有着剧烈的波动，这可能会使得LSTM难以进行有效的编码。而相似的图片经过特征处理后，其特征图往往在向量空间中呈现一个收拢和聚集的趋势，因为这样才能保证后面被全连接层划分边界从而完成分类任务。所以，特征图序列往往能有更加平滑的变化趋势，更容易被LSTM编码。）</span></p><p><img src='https://raw.githubusercontent.com/Unispac/blogImageBed/master/计算机视觉/Video%20Captioning/S2VT/img/1.png' alt='1564736893695' referrerPolicy='no-referrer' /></p><p><span>如图是VGG16的原架构。在S2VT中，我们用它来提取特征时，舍弃了最后两层：FC1000和Softmax。因此产生的特征向量是4096维的。在做特征提取的时候，我们直接使用了caffe zoo中提供的VGG16预训练模型，所有的参数都不再做调整。</span></p><p>&nbsp;</p><h3><a name="lstm-as-encoder" class="md-header-anchor"></a><span>LSTM as Encoder</span></h3><p><span>之前已经说过了，预处理好的特征序列会被送入LSTM，编码成一个固定长度的向量。这个其实很容易理解，因为我们知道RNN的输出是取决于一个输入序列的，把特征序列按照顺序给LSTM过一遍，得到的输出就是一个Sequence to Vector的encode映射：</span></p><p><img src='https://raw.githubusercontent.com/Unispac/blogImageBed/master/计算机视觉/Video%20Captioning/S2VT/img/2.png' alt='1564737901944' referrerPolicy='no-referrer' /></p><p><span>如图，最后一张帧图片的特征向量输入后，LSTM的输出就是我们要的帧序列编码。</span></p><p><span>值得一提的是，在S2VT中，输入的特征向量并不是前面由VGG-16处理后产生的4096维向量。LSTM实际接受的是一个500维的embeded vector。这里我们使用一个简单的4096 to 500的全连接层来完成这个降维。这个全连接层的输出和第一层LSTM encoder的输入相连，它的参数会和LSTM层一起被训练。（之前的VGGNet不需要训练）</span></p><p>&nbsp;</p><h3><a name="lstm-as-decoder" class="md-header-anchor"></a><span>LSTM as Decoder</span></h3><p><img src='https://raw.githubusercontent.com/Unispac/blogImageBed/master/计算机视觉/Video%20Captioning/S2VT/img/3.png' alt='1564738207111' referrerPolicy='no-referrer' /></p><p><span>对帧序列做了编码后，我们接下来希望的就是把这个编码向量解码，产生一个句子序列。LSTM神经元每个时刻接受两个输入，一个是帧序列的编码，一个是上一个生成的单词编码，这两个输入和LSTM自身状态共同决定当前时刻生成的单词。</span></p><p><span>在训练这个Decoder的时候，我们在Ground Truth的单词序列前额外加一个</span><span>&lt;</span><span>BOS</span><span>&gt;</span><span>符号来标识开头，在结尾添加一个</span><span>&lt;</span><span>EOS</span><span>&gt;</span><span>符号表示句子的结束。这样在训练过程中，LSTM就会学到被</span><span>&lt;</span><span>BOS</span><span>&gt;</span><span>激活，开始解码，同时学会在句末输出</span><span>&lt;</span><span>BOS</span><span>&gt;</span><span>标识结束。这样在Infer的时候，我们就可以用</span><span>&lt;</span><span>BOS</span><span>&gt;</span><span>激活它，直到</span><span>&lt;</span><span>EOS</span><span>&gt;</span><span>出现就停止新单词的生成。</span></p><p><span>刚开始看到这个生成机制的时候我也觉得它太复杂了，不大可能会work，但是最后发现它居然work。。。而且work得很好。。</span></p><p>&nbsp;</p><h3><a name="some-details" class="md-header-anchor"></a><span>Some Details</span></h3><p><span>在实际实验的时候，我们固定帧序列总共有80帧，生成的句子连带起始符号一起80个词。因此在实验中，Encoding Stage总共有80个时刻，Decoding Stage是79个时刻（</span><span>&lt;</span><span>BOS</span><span>&gt;</span><span>作为激活信号，是作为初始值输入到Decoder中的，不需要被生成，因此最多只需要生成79个词）。</span></p><p><span>在训练和推理的时候，Encoder在Decoding Stage中的输入都是zero padding，Decoder在Encoding Stage中的输入也都是zero padding。训练的时候，LSTM就会学得对这些zero padding不敏感，自动过滤。</span></p><p><span>我们的实验中两层LSTM各有1000个神经元。Encoder层接受一个500维的embedding向量输入，产生1000维的编码输出。</span></p><p><span>Decoder层产生一个1000维的词向量，这个词向量会被一个1000 to vocal_size的全连接层升维（vocal_size是词典的大小），最后产生一个vocal_size的向量，表示每个单词的score，score越高说明这个单词是GT的概率越大，这个score向量再被softmax处理一下，就成了每一个单词的概率分布。推理的时候，每个时刻产生的词输出就是那个拥有最高概率的词，通过one-hot编码表示（因此是一个vocal_size维的向量）。Decoder的输入是一个500维的词向量和一个1000维的帧序列编码的联合。我们知道这个词向量是上一个生成的词的信息，它原本的输出是一个one-hot的编码，我们用一个vocal_size to 500的全连接层将它降维到500，作为Decoder的输入。</span></p><p>&nbsp;</p><h3><a name="loss" class="md-header-anchor"></a><span>Loss</span></h3><p><img src='https://raw.githubusercontent.com/Unispac/blogImageBed/master/计算机视觉/Video%20Captioning/S2VT/img/4.png' alt='1564740970155' referrerPolicy='no-referrer' /></p><p><span>S2VT的训练实际上就是要最大化上面这一个似然函数，实现一个参数估计，从而对帧序列和词序列之间的概率分布建模。</span></p><p><span>直观上来看，我们实际上就是要让模型最大化Ground Truth在给定的帧序列下的条件概率，即对于给定的帧序列</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.474ex" height="1.76ex" viewBox="0 -504.6 5370.7 757.9" role="img" focusable="false" style="vertical-align: -0.588ex;"><defs><path stroke-width="0" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path stroke-width="0" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path stroke-width="0" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path stroke-width="0" id="E1-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path stroke-width="0" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="808" y="-213"></use><use xlink:href="#E1-MJMAIN-2C" x="1025" y="0"></use><g transform="translate(1470,0)"><use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="808" y="-213"></use></g><use xlink:href="#E1-MJMAIN-2C" x="2495" y="0"></use><use xlink:href="#E1-MJMAIN-2E" x="2940" y="0"></use><use xlink:href="#E1-MJMAIN-2E" x="3385" y="0"></use><use xlink:href="#E1-MJMAIN-2C" x="3829" y="0"></use><g transform="translate(4274,0)"><use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="808" y="-213"></use></g></g></svg></span><script type="math/tex">x_1,x_2,..,x_n</script><span>产生词序列输出</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.392ex" height="1.877ex" viewBox="0 -504.6 5765.9 808.1" role="img" focusable="false" style="vertical-align: -0.705ex;"><defs><path stroke-width="0" id="E2-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path stroke-width="0" id="E2-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E2-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path stroke-width="0" id="E2-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path stroke-width="0" id="E2-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path stroke-width="0" id="E2-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E2-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E2-MJMAIN-31" x="692" y="-213"></use><use xlink:href="#E2-MJMAIN-2C" x="943" y="0"></use><g transform="translate(1388,0)"><use xlink:href="#E2-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E2-MJMAIN-32" x="692" y="-213"></use></g><use xlink:href="#E2-MJMAIN-2C" x="2331" y="0"></use><use xlink:href="#E2-MJMAIN-2E" x="2776" y="0"></use><use xlink:href="#E2-MJMAIN-2E" x="3221" y="0"></use><use xlink:href="#E2-MJMAIN-2E" x="3665" y="0"></use><use xlink:href="#E2-MJMAIN-2C" x="4110" y="0"></use><g transform="translate(4555,0)"><use xlink:href="#E2-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E2-MJMATHI-6D" x="692" y="-213"></use></g></g></svg></span><script type="math/tex">y_1,y_2,...,y_m</script><span>的条件概率。</span></p><p><span>这个似然函数可以进一步分解为上式右边的形式。（由于</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.525ex" height="2.461ex" viewBox="0 -755.9 2809.3 1059.4" role="img" focusable="false" style="vertical-align: -0.705ex;"><defs><path stroke-width="0" id="E3-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path><path stroke-width="0" id="E3-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path stroke-width="0" id="E3-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path stroke-width="0" id="E3-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path stroke-width="0" id="E3-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path stroke-width="0" id="E3-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E3-MJMATHI-68" x="0" y="0"></use><g transform="translate(576,-150)"><use transform="scale(0.707)" xlink:href="#E3-MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E3-MJMAIN-2B" x="600" y="0"></use><use transform="scale(0.707)" xlink:href="#E3-MJMATHI-74" x="1378" y="0"></use><use transform="scale(0.707)" xlink:href="#E3-MJMAIN-2212" x="1739" y="0"></use><use transform="scale(0.707)" xlink:href="#E3-MJMAIN-31" x="2516" y="0"></use></g></g></svg></span><script type="math/tex">h_{n+t-1}</script><span>由前面所有的</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.127ex" height="1.76ex" viewBox="0 -504.6 916 757.9" role="img" focusable="false" style="vertical-align: -0.588ex;"><defs><path stroke-width="0" id="E4-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path stroke-width="0" id="E4-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E4-MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E4-MJMATHI-69" x="808" y="-213"></use></g></svg></span><script type="math/tex">x_i</script><span>和</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.642ex" height="1.877ex" viewBox="0 -504.6 6304.1 808.1" role="img" focusable="false" style="vertical-align: -0.705ex;"><defs><path stroke-width="0" id="E5-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path stroke-width="0" id="E5-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E5-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path stroke-width="0" id="E5-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path stroke-width="0" id="E5-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path stroke-width="0" id="E5-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path stroke-width="0" id="E5-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E5-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E5-MJMAIN-31" x="692" y="-213"></use><use xlink:href="#E5-MJMAIN-2C" x="943" y="0"></use><g transform="translate(1388,0)"><use xlink:href="#E5-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E5-MJMAIN-32" x="692" y="-213"></use></g><use xlink:href="#E5-MJMAIN-2C" x="2331" y="0"></use><use xlink:href="#E5-MJMAIN-2E" x="2776" y="0"></use><use xlink:href="#E5-MJMAIN-2E" x="3221" y="0"></use><use xlink:href="#E5-MJMAIN-2E" x="3665" y="0"></use><use xlink:href="#E5-MJMAIN-2C" x="4110" y="0"></use><g transform="translate(4555,0)"><use xlink:href="#E5-MJMATHI-79" x="0" y="0"></use><g transform="translate(490,-150)"><use transform="scale(0.707)" xlink:href="#E5-MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E5-MJMAIN-2212" x="361" y="0"></use><use transform="scale(0.707)" xlink:href="#E5-MJMAIN-32" x="1139" y="0"></use></g></g></g></svg></span><script type="math/tex">y_1,y_2,...,y_{t-2}</script><span>决定，所以：</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="48.518ex" height="2.577ex" viewBox="-39 -806.1 20889.7 1109.7" role="img" focusable="false" style="vertical-align: -0.705ex; margin-left: -0.091ex;"><defs><path stroke-width="0" id="E6-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path stroke-width="0" id="E6-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path stroke-width="0" id="E6-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path stroke-width="0" id="E6-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path stroke-width="0" id="E6-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path><path stroke-width="0" id="E6-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path><path stroke-width="0" id="E6-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path stroke-width="0" id="E6-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path stroke-width="0" id="E6-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path stroke-width="0" id="E6-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E6-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path stroke-width="0" id="E6-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path stroke-width="0" id="E6-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path stroke-width="0" id="E6-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path stroke-width="0" id="E6-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="#E6-MJMATHI-70" x="0" y="0"></use><use xlink:href="#E6-MJMAIN-28" x="503" y="0"></use><g transform="translate(892,0)"><use xlink:href="#E6-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMATHI-74" x="692" y="-213"></use></g><use xlink:href="#E6-MJMAIN-7C" x="1737" y="0"></use><g transform="translate(2015,0)"><use xlink:href="#E6-MJMATHI-68" x="0" y="0"></use><g transform="translate(576,-150)"><use transform="scale(0.707)" xlink:href="#E6-MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-2B" x="600" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMATHI-74" x="1378" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-2212" x="1739" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-31" x="2516" y="0"></use></g></g><use xlink:href="#E6-MJMAIN-2C" x="4824" y="0"></use><g transform="translate(5269,0)"><use xlink:href="#E6-MJMATHI-79" x="0" y="0"></use><g transform="translate(490,-150)"><use transform="scale(0.707)" xlink:href="#E6-MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-2212" x="361" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-31" x="1139" y="0"></use></g></g><use xlink:href="#E6-MJMAIN-29" x="7018" y="0"></use><use xlink:href="#E6-MJMAIN-3D" x="7684" y="0"></use><use xlink:href="#E6-MJMATHI-70" x="8740" y="0"></use><use xlink:href="#E6-MJMAIN-28" x="9243" y="0"></use><g transform="translate(9632,0)"><use xlink:href="#E6-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMATHI-74" x="692" y="-213"></use></g><use xlink:href="#E6-MJMAIN-7C" x="10478" y="0"></use><g transform="translate(10756,0)"><use xlink:href="#E6-MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-31" x="808" y="-213"></use></g><use xlink:href="#E6-MJMAIN-2C" x="11781" y="0"></use><use xlink:href="#E6-MJMAIN-2E" x="12226" y="0"></use><use xlink:href="#E6-MJMAIN-2E" x="12670" y="0"></use><use xlink:href="#E6-MJMAIN-2E" x="13115" y="0"></use><use xlink:href="#E6-MJMAIN-2C" x="13560" y="0"></use><g transform="translate(14004,0)"><use xlink:href="#E6-MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMATHI-6E" x="808" y="-213"></use></g><use xlink:href="#E6-MJMAIN-2C" x="15101" y="0"></use><g transform="translate(15545,0)"><use xlink:href="#E6-MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-31" x="692" y="-213"></use></g><use xlink:href="#E6-MJMAIN-2C" x="16489" y="0"></use><use xlink:href="#E6-MJMAIN-2E" x="16934" y="0"></use><use xlink:href="#E6-MJMAIN-2E" x="17378" y="0"></use><use xlink:href="#E6-MJMAIN-2E" x="17823" y="0"></use><use xlink:href="#E6-MJMAIN-2C" x="18268" y="0"></use><g transform="translate(18712,0)"><use xlink:href="#E6-MJMATHI-79" x="0" y="0"></use><g transform="translate(490,-150)"><use transform="scale(0.707)" xlink:href="#E6-MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-2212" x="361" y="0"></use><use transform="scale(0.707)" xlink:href="#E6-MJMAIN-31" x="1139" y="0"></use></g></g><use xlink:href="#E6-MJMAIN-29" x="20461" y="0"></use></g></svg></span><script type="math/tex">p(y_t|h_{n+t-1},y_{t-1})=p(y_t|x_1,...,x_n,y_1,...,y_{t-1})</script><span>。显然，上面累乘起来就是左式。）</span></p><p><img src='https://raw.githubusercontent.com/Unispac/blogImageBed/master/计算机视觉/Video%20Captioning/S2VT/img/5.png' alt='1564742101270' referrerPolicy='no-referrer' /></p><p><span>为了防止梯度爆炸，可以进一步改写成上面对数似然函数的形式。</span></p><p><span>而上面这个条件概率函数怎么来的呢？这就是我们的LSTM真正建模的对象。前面帧序列编码+历史输出一起在LSTM中过了一遍后，产生的输出经过一个升维的FC和softmax产生的就是上面这个p。用训练数据来最大化上面这个似然函数，就可以让这个p尽可能的逼近真实分布。参数调优本质上就是个参数估计的过程。</span></p><p>&nbsp;</p><h3><a name="implementation" class="md-header-anchor"></a><span>Implementation</span></h3><p><span>参考了两份实现：</span></p><ul><li><a href='https://github.com/chenxinpeng/S2VT' target='_blank' class='url'>https://github.com/chenxinpeng/S2VT</a></li><li><a href='https://github.com/vijayvee/video-captioning' target='_blank' class='url'>https://github.com/vijayvee/video-captioning</a></li></ul><p><span>代码阅读并重构后（python3）：</span><a href='https://github.com/Unispac/Video-Captioning' target='_blank' class='url'>https://github.com/Unispac/Video-Captioning</a></p><p><span>一些细节：</span></p><ul><li><span>固定：Encoding Stage 80 步，Decoding Stage 79步</span></li><li><span>两层LSTM都是1000维的</span></li><li><span>第一层接收的特征向量500维，第二层接收500维的词向量和1000维的帧序列编码。</span></li><li><span>Batch_Size = 10，每次随机从数据中抽10组video的帧序列和一个随机的GT句。（MSR-VTT中一个Video给了多个GT句子，针对视频不同的aspect做描述，或者使用不同的句式）</span></li><li><span>learning_rate=0.0001</span></li><li><span>Training的时候，给第二个LSTM层输入的“上一个生成的词”是从GT里面拿的，而不是从训练时生成的词中拿的。推理的时候才从训练时生成的词中拿。</span></li><li><span>Infer的时候，整个模型被执行了多次，每次跑满了159步，第i次，只收集Decoding Stage生成的前i个词序列，如果最后一个词是</span><span>&lt;</span><span>EOS</span><span>&gt;</span><span>，就停止，否则就把这i个词作为下一次第二层LSTM的前i个生成输入，帮助生成第i+1个词。</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div>
</body>
</html>